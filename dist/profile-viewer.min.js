class ProfileViewer{constructor(t,e,i){if(this.selections=[],this.offsetX=0,this.offsetY=0,this.isWheeling=!1,this.canWheelDown=!0,this.scrollPosition=0,this.isResizing=!1,this.isDocumentScrolling=!1,this.isMouseMove=!1,this.scale=window.devicePixelRatio,this.borderWidth=2,this.padding=2,this.fontConfig="10px sans-serif",this.borderColor="#fff",this.selectorLabel="Thread",this.boxHeight=24,this.destroyed=!1,!(t="string"==typeof t?document.querySelector(t):t))throw new Error("Invalid parent element specified.");this.container=t,i&&(this.selectorLabel=i),this.insertDOM(),this.getStyles(),this.registerResizeObserver(),this.registerScrollListener(),e&&this.setData(e),this.getOffset()}destroy(){for(this.destroyed=!0,this.resizeObserver.disconnect(),this.scrollHandler&&document.removeEventListener("scroll",this.scrollHandler),this.stylesheet&&0===parseInt(this.stylesheet.dataset.references)&&document.head.removeChild(this.stylesheet);this.container.firstChild;)this.container.removeChild(this.container.lastChild)}setData(t){if(this.destroyed)console.error("This profile viewer is destroyed.");else{if(!t)return this.data=t,void this.clear();const e=Object.keys(t);e.sort((t,e)=>"all"===t?-1:"all"===e?1:t<e?-1:e<t?1:0),this.data=t,this.selections=e,this.currentSelection=this.selections[0],this.activeNode=this.data[this.currentSelection],this.updateFilter(),this.redraw()}}setSelectorLabel(t){this.selectorLabel=t,this.selectorLabelElement.innerText=t+": "}registerCtrlClickHandler(t){this.ctrlClickHandler=t}registerThreadSelectorHandler(t){this.selectionHandler=t}registerSelectionHandler(t){this.selectionHandler=t}registerScrollListener(){document.addEventListener("scroll",this.scrollHandler)}clear(){this.selections=[],this.currentSelection="",this.activeNode=void 0,this.canvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.hoverCanvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}isDestroyed(){return this.destroyed}getStyles(){var t=window.getComputedStyle(this.container,null),e=t.fontFamily,i=t.fontSize,e=(this.fontConfig=parseInt(null!=i?i:"12px",10)*this.scale+"px "+(null!=e?e:"sans-serif"),this.borderColor=null!=(i=t.color)?i:"#000",this.canvasCtx.font=this.fontConfig,this.canvasCtx.textBaseline="middle",this.canvasCtx.measureText("ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]*'\"^_`abcdefghijklmnopqrstuvwxyz"));this.boxHeight=Math.ceil(((null!=(t=e.fontBoundingBoxDescent)?t:e.actualBoundingBoxDescent)+(null!=(i=e.fontBoundingBoxAscent)?i:e.actualBoundingBoxAscent)+2*this.borderWidth+2*this.padding)*this.scale),this.activeNode&&this.redraw()}redraw(){this.canWheelDown=!1,this.canvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.clearHover(),this.drawGraph(this.activeNode,this.canvasWidth,this.canvasHeight,0,this.scrollPosition)}insertDOM(){this.insertStylesheet(),this.canvas=document.createElement("canvas"),this.canvas.classList.add("__profiler-canvas"),this.canvasCtx=this.canvas.getContext("2d"),this.hoverCanvas=document.createElement("canvas"),this.hoverCanvas.classList.add("__profiler-hover-canvas"),this.hoverCanvasCtx=this.hoverCanvas.getContext("2d");const t=document.createElement("div");t.classList.add("__profiler-canvas-container"),t.appendChild(this.canvas),t.appendChild(this.hoverCanvas),t.appendChild(this.createTooltip()),this.container.appendChild(this.createFilterContainer()),this.container.appendChild(t),this.canvas.addEventListener("wheel",t=>{if(this.activeNode&&(!(0<t.deltaY)||this.canWheelDown)){var e;if(t.deltaY<0&&0===this.scrollPosition)if(-t.deltaY>this.boxHeight)return void((e=this.findParentNode(this.activeNode))&&(t.preventDefault(),t.stopPropagation(),this.clearHover(),this.activeNode=e,this.redraw()));t.preventDefault(),t.stopPropagation(),this.isWheeling||(window.requestAnimationFrame(()=>{this.scrollPosition=Math.min(0,this.scrollPosition-t.deltaY),this.redraw(),this.isWheeling=!1}),this.isWheeling=!0)}}),this.canvas.addEventListener("mousemove",s=>{!this.isMouseMove&&this.activeNode&&(window.requestAnimationFrame(()=>{this.getOffset();var t=s.clientX-this.offsetX,e=s.clientY-this.offsetY,i=(this.hoverCanvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.drawHover(this.activeNode,this.scale*t,this.scale*e));i?(t>this.canvasWidthCSS/2?(this.tooltipElement.style.right=this.canvasWidthCSS-t+10+"px",this.tooltipElement.style.left="unset"):(this.tooltipElement.style.right="unset",this.tooltipElement.style.left=10+t+"px"),e>this.canvasHeightCSS/2?(this.tooltipElement.style.bottom=this.canvasHeightCSS-e+10+"px",this.tooltipElement.style.top="unset"):(this.tooltipElement.style.bottom="unset",this.tooltipElement.style.top=10+e+"px"),this.tooltipElement.style.display="block"):this.tooltipElement.style.display="none",this.isMouseMove=!1}),this.isMouseMove=!0)}),this.canvas.addEventListener("click",t=>{var e,i;this.activeNode&&(t.preventDefault(),t.stopPropagation(),this.getOffset(),e=this.scale*(t.clientX-this.offsetX),i=this.scale*(t.clientY-this.offsetY),t.ctrlKey||t.metaKey?this.runOnNodeAtMousePosition(this.activeNode,e,i,t=>{this.ctrlClickHandler&&this.ctrlClickHandler(t)}):this.zoomInOnNode(this.activeNode,e,i)?(this.scrollPosition=0,this.redraw()):2===t.detail&&this.resetView())})}resetView(){this.activeNode=this.data[this.currentSelection],this.scrollPosition=0,this.redraw()}insertStylesheet(){const t=document.querySelector("#__profiler_stylesheet");t?(t.dataset.references=(parseInt(t.dataset.references)+1).toString(),this.stylesheet=t):(this.stylesheet=document.createElement("style"),this.stylesheet.setAttribute("id","__profiler-stylesheet"),this.stylesheet.dataset.references="0",this.stylesheet.innerText=`
                .__profiler-canvas {
                    z-index: 0;
                    position: absolute;
                    width: 100%;
                }
                .__profiler-canvas-container {
                  width: 100%;
                  height: 100%;
                  position: relative;
                }
                .__profiler-hover-canvas {
                    z-index: 1;
                    position: absolute;
                    pointer-events: none;
                    width: 100%;
                }
                .__profiler-tooltip {
                    z-index: 2;
                    display: none;
                    position: absolute;
                    background-color: #ddd;
                    border: 1px solid black;
                    padding: 5px 10px;
                    pointer-events: none;
                    max-width: 45%;
                    overflow: hidden;
                }
                .__profiler-tooltip > div {
                    line-break: anywhere;
                }
                .__profiler-filter {
                    height: 30px;
                    padding: 2px 16px;
                    margin: 0;
                    box-sizing: border-box;
                    border-bottom: 1px solid #444;
                    user-select: none;
                }
                .__profiler-reset {
                    float: right;
                }
            `,document.head.appendChild(this.stylesheet))}createTooltip(){this.tooltipElement=document.createElement("div"),this.tooltipElement.classList.add("__profiler-tooltip"),this.tooltip={count:document.createElement("span"),percentage:document.createElement("span"),function:document.createElement("code"),file:document.createElement("a"),flags:document.createElement("span")},this.tooltip.function.classList.add("fname");for(const t of[[this.tooltip.function],[this.tooltip.count,document.createTextNode(" ("),this.tooltip.percentage,document.createTextNode(") ")],[this.tooltip.file],[this.tooltip.flags]]){const e=document.createElement("div");for(const i of t)e.appendChild(i);this.tooltipElement.appendChild(e)}return this.tooltip.ctrlClickHint=document.createElement("small"),this.tooltipElement.appendChild(this.tooltip.ctrlClickHint),this.container.appendChild(this.tooltipElement),this.tooltipElement}createFilterContainer(){this.filterContainer=document.createElement("div"),this.filterContainer.classList.add("__profiler-filter"),this.selectorLabelElement=document.createElement("label"),this.selectorLabelElement.innerText=this.selectorLabel+": ",this.filterContainer.appendChild(this.selectorLabelElement),this.filterInput=document.createElement("select"),this.filterInput.addEventListener("change",()=>{this.currentSelection=this.filterInput.value,this.selectionHandler&&this.selectionHandler(this.currentSelection),this.resetView()}),this.filterContainer.appendChild(this.filterInput);const t=document.createElement("button");return t.classList.add("__profiler-reset"),t.innerText="reset view",t.addEventListener("click",()=>{this.resetView()}),this.filterContainer.appendChild(t),this.filterContainer}updateFilter(){for(;this.filterInput.firstChild;)this.filterInput.removeChild(this.filterInput.lastChild);for(const t of this.selections){const e=document.createElement("option");e.innerText=t,e.setAttribute("value",t),this.filterInput.appendChild(e)}}registerResizeObserver(){this.resizeObserver=new ResizeObserver(t=>{if(!this.isResizing){for(const e of t)e.target===this.container&&window.requestAnimationFrame(()=>{window.devicePixelRatio!==this.scale&&(this.scale=window.devicePixelRatio,this.getStyles()),this.canvasWidth=Math.round(e.contentRect.width*this.scale),this.canvasHeight=Math.round((e.contentRect.height-30)*this.scale),this.canvasWidthCSS=e.contentRect.width,this.canvasHeightCSS=e.contentRect.height,this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight,this.hoverCanvas.width=this.canvasWidth,this.hoverCanvas.height=this.canvasHeight,this.redraw(),this.isResizing=!1});this.isResizing=!0}}),this.resizeObserver.observe(this.container)}scrollHandler(t){this.isDocumentScrolling||(window.requestAnimationFrame(()=>{this.getOffset(),this.isDocumentScrolling=!1}),this.isDocumentScrolling=!0)}getOffset(){var t=this.canvas.getBoundingClientRect();this.offsetX=t.left,this.offsetY=t.top}nodeHash(t){const e=t.file+t.line;let i=0;for(let t=0;t<e.length;t++){var s=e.charCodeAt(t);i=(i<<5)-i+s,i&=i}return i}mulberry32(e){return function(){var t=e+=1831565813,t=Math.imul(t^t>>>15,1|t);return(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}}modifyNodeColorByHash(t,e,i,s,o=70){const n=this.mulberry32(s);return t===e&&e===i?t=e=i=Math.min(255,Math.max(0,t+(n()-.5)*o)):(t=Math.min(255,Math.max(0,t+(n()-.5)*o)),e=Math.min(255,Math.max(0,e+(n()-.5)*o)),i=Math.min(255,Math.max(0,i+(n()-.5)*o))),{r:t,g:e,b:i}}nodeColors(t,e){let i,s,o,n=1;return 1&t.flags?{r:i,g:s,b:o}=this.modifyNodeColorByHash(204,103,103,e,20):2&t.flags?{r:i,g:s,b:o}=this.modifyNodeColorByHash(204,153,68,e,20):8&t.flags?{r:i,g:s,b:o}=this.modifyNodeColorByHash(100,100,100,e,60):{r:i,g:s,b:o}=this.modifyNodeColorByHash(64,99,221,e),16&t.flags&&(n=.5),{fill:"rgba("+i+","+s+","+o+","+n+")",stroke:"rgba("+.8*i+","+.8*s+","+.8*o+","+n+")",text:"rgba(255, 255, 255, "+Math.max(.6,n)+")"}}drawGraph(t,e,i,s,o){var n,h,r;if(t)if(this.canvasCtx.font=this.fontConfig,this.canvasCtx.textBaseline="middle",0<=o+this.boxHeight&&(n=this.nodeHash(t),{fill:n,stroke:h,text:r}=this.nodeColors(t,n),this.drawNode(t.func,n,h,r,e,s,o)),t.pos={x:s,y:o,width:e,height:this.boxHeight},o+this.boxHeight<=this.canvasHeight)for(const l of t.children){var a=e*(l.fraction||l.count/t.count);this.drawGraph(l,a,i,s,o+this.boxHeight),s+=a}else this.canWheelDown=!0}drawNode(t,e,i,s,o,n,h){o<1&&(o=1);this.canvasCtx.fillStyle=e,this.canvasCtx.beginPath(),this.canvasCtx.rect(n,h+this.borderWidth,o,this.boxHeight-this.borderWidth),this.canvasCtx.closePath(),this.canvasCtx.fill();e=o-2*this.padding-2*this.borderWidth;10<e&&(this.canvasCtx.save(),this.canvasCtx.beginPath(),this.canvasCtx.rect(n+this.borderWidth+this.padding,h+this.borderWidth+this.padding,e,this.boxHeight-this.borderWidth-2*this.padding),this.canvasCtx.closePath(),this.canvasCtx.clip(),this.canvasCtx.fillStyle=s,this.canvasCtx.fillText(t,n+this.borderWidth+this.padding,h+this.boxHeight/2+this.borderWidth),this.canvasCtx.restore())}updateTooltip(t){this.tooltip.function.innerText=t.func,t.file||0<t.line?this.tooltip.file.innerText=t.file+":"+t.line:this.tooltip.file.innerText="",this.tooltip.count.innerText=(t.countLabel||t.count+" samples").toString();let e=(100*t.count/this.data[this.currentSelection].count).toFixed()+"% of root";this.activeNode.count!=this.data[this.currentSelection].count&&(e=e+", "+(100*t.count/this.activeNode.count).toFixed()+"% of selection"),this.tooltip.percentage.innerText=e;const i=[];1&t.flags&&i.push("runtime-dispatch"),2&t.flags&&i.push("GC"),8&t.flags&&i.push("compilation"),16&t.flags&&i.push("task");let s="";0<i.length&&(s="Flags: "+i.join(", ")),this.tooltip.flags.innerText=s,this.ctrlClickHandler&&(this.tooltip.ctrlClickHint.innerText="Ctrl/Cmd+Click to open this file")}drawHoverNode(t){this.hoverCanvasCtx.fillStyle=this.borderColor,this.hoverCanvasCtx.fillRect(t.pos.x,t.pos.y+this.borderWidth,Math.max(1,t.pos.width),t.pos.height-this.borderWidth);var e=t.pos.width-2*this.borderWidth*this.scale;1<e&&this.hoverCanvasCtx.clearRect(t.pos.x+this.borderWidth*this.scale,t.pos.y+2*this.borderWidth*this.scale,e,t.pos.height-3*this.borderWidth*this.scale),this.updateTooltip(t)}clearHover(){this.hoverCanvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.tooltipElement.style.display="none"}drawHover(t,e,i){let s=!1;return this.runOnNodeAtMousePosition(t,e,i,t=>{this.drawHoverNode(t),s=!0}),s}runOnNodeAtMousePosition(t,e,i,s){if(e>=Math.floor(t.pos.x)&&e<=Math.ceil(t.pos.x+t.pos.width)&&i>=t.pos.y){if(i<=t.pos.y+t.pos.height)return s(t),!0;for(const o of t.children)if(this.runOnNodeAtMousePosition(o,e,i,s))return!0}return!1}zoomInOnNode(t,e,i){let s=!1;return this.runOnNodeAtMousePosition(t,e,i,t=>{this.clearHover(),this.activeNode=t,s=!0}),s}findParentNode(t,e=null){for(const s of(e=null===e?this.data[this.currentSelection]:e).children){if(s===t)return e;var i=this.findParentNode(t,s);if(i)return i}return null}}export{ProfileViewer};