var ProfileViewer=function(){function t(t,e,i){if(this.selections=[],this.offsetX=0,this.offsetY=0,this.isWheeling=!1,this.canWheelDown=!0,this.scrollPosition=0,this.isResizing=!1,this.isDocumentScrolling=!1,this.isMouseMove=!1,this.scale=window.devicePixelRatio,this.borderWidth=2,this.padding=2,this.fontConfig="10px sans-serif",this.borderColor="#fff",this.selectorLabel="Thread",this.boxHeight=24,this.destroyed=!1,!(t="string"==typeof t?document.querySelector(t):t))throw new Error("Invalid parent element specified.");this.container=t,i&&(this.selectorLabel=i),this.insertDOM(),this.getStyles(),this.registerResizeObserver(),this.registerScrollListener(),e&&this.setData(e),this.getOffset()}return t.prototype.destroy=function(){for(this.destroyed=!0,this.resizeObserver.disconnect(),this.scrollHandler&&document.removeEventListener("scroll",this.scrollHandler),this.stylesheet&&0===parseInt(this.stylesheet.dataset.references)&&document.head.removeChild(this.stylesheet);this.container.firstChild;)this.container.removeChild(this.container.lastChild)},t.prototype.setData=function(t){if(this.destroyed)console.error("This profile viewer is destroyed.");else{if(!t)return this.data=t,void this.clear();var e=Object.keys(t);e.sort(function(t,e){return"all"===t?-1:"all"===e?1:t<e?-1:e<t?1:0}),this.data=t,this.selections=e,this.currentSelection=this.selections[0],this.activeNode=this.data[this.currentSelection],this.updateFilter(),this.redraw()}},t.prototype.setSelectorLabel=function(t){this.selectorLabel=t,this.selectorLabelElement.innerText="".concat(t,": ")},t.prototype.registerCtrlClickHandler=function(t){this.ctrlClickHandler=t},t.prototype.registerThreadSelectorHandler=function(t){this.selectionHandler=t},t.prototype.registerSelectionHandler=function(t){this.selectionHandler=t},t.prototype.registerScrollListener=function(){document.addEventListener("scroll",this.scrollHandler)},t.prototype.clear=function(){this.selections=[],this.currentSelection="",this.activeNode=void 0,this.canvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.hoverCanvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight)},t.prototype.isDestroyed=function(){return this.destroyed},t.prototype.getStyles=function(){var t=window.getComputedStyle(this.container,null),e=t.fontFamily,i=t.fontSize,e=(this.fontConfig=parseInt(null!=i?i:"12px",10)*this.scale+"px "+(null!=e?e:"sans-serif"),this.borderColor=null!=(i=t.color)?i:"#000",this.canvasCtx.font=this.fontConfig,this.canvasCtx.textBaseline="middle",this.canvasCtx.measureText("ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]*'\"^_`abcdefghijklmnopqrstuvwxyz"));this.boxHeight=Math.ceil(((null!=(t=e.fontBoundingBoxDescent)?t:e.actualBoundingBoxDescent)+(null!=(i=e.fontBoundingBoxAscent)?i:e.actualBoundingBoxAscent)+2*this.borderWidth+2*this.padding)*this.scale),this.activeNode&&this.redraw()},t.prototype.redraw=function(){this.canWheelDown=!1,this.canvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.clearHover(),this.drawGraph(this.activeNode,this.canvasWidth,this.canvasHeight,0,this.scrollPosition)},t.prototype.insertDOM=function(){var n=this,t=(this.insertStylesheet(),this.canvas=document.createElement("canvas"),this.canvas.classList.add("__profiler-canvas"),this.canvasCtx=this.canvas.getContext("2d"),this.hoverCanvas=document.createElement("canvas"),this.hoverCanvas.classList.add("__profiler-hover-canvas"),this.hoverCanvasCtx=this.hoverCanvas.getContext("2d"),document.createElement("div"));t.classList.add("__profiler-canvas-container"),t.appendChild(this.canvas),t.appendChild(this.hoverCanvas),t.appendChild(this.createTooltip()),this.container.appendChild(this.createFilterContainer()),this.container.appendChild(t),this.canvas.addEventListener("wheel",function(t){if(n.activeNode&&(!(0<t.deltaY)||n.canWheelDown)){var e;if(t.deltaY<0&&0===n.scrollPosition)if(-t.deltaY>n.boxHeight)return void((e=n.findParentNode(n.activeNode))&&(t.preventDefault(),t.stopPropagation(),n.clearHover(),n.activeNode=e,n.redraw()));t.preventDefault(),t.stopPropagation(),n.isWheeling||(window.requestAnimationFrame(function(){n.scrollPosition=Math.min(0,n.scrollPosition-t.deltaY),n.redraw(),n.isWheeling=!1}),n.isWheeling=!0)}}),this.canvas.addEventListener("mousemove",function(i){!n.isMouseMove&&n.activeNode&&(window.requestAnimationFrame(function(){n.getOffset();var t=i.clientX-n.offsetX,e=i.clientY-n.offsetY;n.hoverCanvasCtx.clearRect(0,0,n.canvasWidth,n.canvasHeight),n.drawHover(n.activeNode,n.scale*t,n.scale*e)?(t>n.canvasWidthCSS/2?(n.tooltipElement.style.right=n.canvasWidthCSS-t+10+"px",n.tooltipElement.style.left="unset"):(n.tooltipElement.style.right="unset",n.tooltipElement.style.left=10+t+"px"),e>n.canvasHeightCSS/2?(n.tooltipElement.style.bottom=n.canvasHeightCSS-e+10+"px",n.tooltipElement.style.top="unset"):(n.tooltipElement.style.bottom="unset",n.tooltipElement.style.top=10+e+"px"),n.tooltipElement.style.display="block"):n.tooltipElement.style.display="none",n.isMouseMove=!1}),n.isMouseMove=!0)}),this.canvas.addEventListener("click",function(t){var e,i;n.activeNode&&(t.preventDefault(),t.stopPropagation(),n.getOffset(),e=n.scale*(t.clientX-n.offsetX),i=n.scale*(t.clientY-n.offsetY),t.ctrlKey||t.metaKey?n.runOnNodeAtMousePosition(n.activeNode,e,i,function(t){n.ctrlClickHandler&&n.ctrlClickHandler(t)}):n.zoomInOnNode(n.activeNode,e,i)?(n.scrollPosition=0,n.redraw()):2===t.detail&&n.resetView())})},t.prototype.resetView=function(){this.activeNode=this.data[this.currentSelection],this.scrollPosition=0,this.redraw()},t.prototype.insertStylesheet=function(){var t=document.querySelector("#__profiler_stylesheet");t?(t.dataset.references=(parseInt(t.dataset.references)+1).toString(),this.stylesheet=t):(this.stylesheet=document.createElement("style"),this.stylesheet.setAttribute("id","__profiler-stylesheet"),this.stylesheet.dataset.references="0",this.stylesheet.innerText="\n                .__profiler-canvas {\n                    z-index: 0;\n                    position: absolute;\n                    width: 100%;\n                }\n                .__profiler-canvas-container {\n                  width: 100%;\n                  height: 100%;\n                  position: relative;\n                }\n                .__profiler-hover-canvas {\n                    z-index: 1;\n                    position: absolute;\n                    pointer-events: none;\n                    width: 100%;\n                }\n                .__profiler-tooltip {\n                    z-index: 2;\n                    display: none;\n                    position: absolute;\n                    background-color: #ddd;\n                    border: 1px solid black;\n                    padding: 5px 10px;\n                    pointer-events: none;\n                    max-width: 45%;\n                    overflow: hidden;\n                }\n                .__profiler-tooltip > div {\n                    line-break: anywhere;\n                }\n                .__profiler-filter {\n                    height: 30px;\n                    padding: 2px 16px;\n                    margin: 0;\n                    box-sizing: border-box;\n                    border-bottom: 1px solid #444;\n                    user-select: none;\n                }\n                .__profiler-reset {\n                    float: right;\n                }\n            ",document.head.appendChild(this.stylesheet))},t.prototype.createTooltip=function(){this.tooltipElement=document.createElement("div"),this.tooltipElement.classList.add("__profiler-tooltip"),this.tooltip={count:document.createElement("span"),percentage:document.createElement("span"),function:document.createElement("code"),file:document.createElement("a"),flags:document.createElement("span")},this.tooltip.function.classList.add("fname");for(var t=0,e=[[this.tooltip.function],[this.tooltip.count,document.createTextNode(" ("),this.tooltip.percentage,document.createTextNode(") ")],[this.tooltip.file],[this.tooltip.flags]];t<e.length;t++){for(var i=e[t],n=document.createElement("div"),o=0,s=i;o<s.length;o++){var r=s[o];n.appendChild(r)}this.tooltipElement.appendChild(n)}return this.tooltip.ctrlClickHint=document.createElement("small"),this.tooltipElement.appendChild(this.tooltip.ctrlClickHint),this.container.appendChild(this.tooltipElement),this.tooltipElement},t.prototype.createFilterContainer=function(){var t=this,e=(this.filterContainer=document.createElement("div"),this.filterContainer.classList.add("__profiler-filter"),this.selectorLabelElement=document.createElement("label"),this.selectorLabelElement.innerText="".concat(this.selectorLabel,": "),this.filterContainer.appendChild(this.selectorLabelElement),this.filterInput=document.createElement("select"),this.filterInput.addEventListener("change",function(){t.currentSelection=t.filterInput.value,t.selectionHandler&&t.selectionHandler(t.currentSelection),t.resetView()}),this.filterContainer.appendChild(this.filterInput),document.createElement("button"));return e.classList.add("__profiler-reset"),e.innerText="reset view",e.addEventListener("click",function(){t.resetView()}),this.filterContainer.appendChild(e),this.filterContainer},t.prototype.updateFilter=function(){for(;this.filterInput.firstChild;)this.filterInput.removeChild(this.filterInput.lastChild);for(var t=0,e=this.selections;t<e.length;t++){var i=e[t],n=document.createElement("option");n.innerText=i,n.setAttribute("value",i),this.filterInput.appendChild(n)}},t.prototype.registerResizeObserver=function(){var n=this;this.resizeObserver=new ResizeObserver(function(t){if(!n.isResizing){for(var e=0,i=t;e<i.length;e++)!function(t){t.target===n.container&&window.requestAnimationFrame(function(){window.devicePixelRatio!==n.scale&&(n.scale=window.devicePixelRatio,n.getStyles()),n.canvasWidth=Math.round(t.contentRect.width*n.scale),n.canvasHeight=Math.round((t.contentRect.height-30)*n.scale),n.canvasWidthCSS=t.contentRect.width,n.canvasHeightCSS=t.contentRect.height,n.canvas.width=n.canvasWidth,n.canvas.height=n.canvasHeight,n.hoverCanvas.width=n.canvasWidth,n.hoverCanvas.height=n.canvasHeight,n.redraw(),n.isResizing=!1})}(i[e]);n.isResizing=!0}}),this.resizeObserver.observe(this.container)},t.prototype.scrollHandler=function(t){var e=this;this.isDocumentScrolling||(window.requestAnimationFrame(function(){e.getOffset(),e.isDocumentScrolling=!1}),this.isDocumentScrolling=!0)},t.prototype.getOffset=function(){var t=this.canvas.getBoundingClientRect();this.offsetX=t.left,this.offsetY=t.top},t.prototype.nodeHash=function(t){for(var e=t.file+t.line,i=0,n=0;n<e.length;n++){i=(i<<5)-i+e.charCodeAt(n);i&=i}return i},t.prototype.mulberry32=function(e){return function(){var t=e+=1831565813,t=Math.imul(t^t>>>15,1|t);return(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}},t.prototype.modifyNodeColorByHash=function(t,e,i,n,o){void 0===o&&(o=70);n=this.mulberry32(n);return t===e&&e===i?t=e=i=Math.min(255,Math.max(0,t+(n()-.5)*o)):(t=Math.min(255,Math.max(0,t+(n()-.5)*o)),e=Math.min(255,Math.max(0,e+(n()-.5)*o)),i=Math.min(255,Math.max(0,i+(n()-.5)*o))),{r:t,g:e,b:i}},t.prototype.nodeColors=function(t,e){var i,n,o,s=1,e=1&t.flags?(n=(i=this.modifyNodeColorByHash(204,103,103,e,20)).r,o=i.g,i.b):2&t.flags?(n=(i=this.modifyNodeColorByHash(204,153,68,e,20)).r,o=i.g,i.b):8&t.flags?(n=(i=this.modifyNodeColorByHash(100,100,100,e,60)).r,o=i.g,i.b):(n=(i=this.modifyNodeColorByHash(64,99,221,e)).r,o=i.g,i.b);return{fill:"rgba("+n+","+o+","+e+","+(s=16&t.flags?.5:s)+")",stroke:"rgba("+.8*n+","+.8*o+","+.8*e+","+s+")",text:"rgba(255, 255, 255, "+Math.max(.6,s)+")"}},t.prototype.drawGraph=function(t,e,i,n,o){var s,r,a;if(t)if(this.canvasCtx.font=this.fontConfig,this.canvasCtx.textBaseline="middle",0<=o+this.boxHeight&&(a=this.nodeHash(t),s=(a=this.nodeColors(t,a)).fill,r=a.stroke,a=a.text,this.drawNode(t.func,s,r,a,e,n,o)),t.pos={x:n,y:o,width:e,height:this.boxHeight},o+this.boxHeight<=this.canvasHeight)for(var l=0,h=t.children;l<h.length;l++){var c=h[l],d=e*(c.fraction||c.count/t.count);this.drawGraph(c,d,i,n,o+this.boxHeight),n+=d}else this.canWheelDown=!0},t.prototype.drawNode=function(t,e,i,n,o,s,r){o<1&&(o=1);this.canvasCtx.fillStyle=e,this.canvasCtx.beginPath(),this.canvasCtx.rect(s,r+this.borderWidth,o,this.boxHeight-this.borderWidth),this.canvasCtx.closePath(),this.canvasCtx.fill();e=o-2*this.padding-2*this.borderWidth;10<e&&(this.canvasCtx.save(),this.canvasCtx.beginPath(),this.canvasCtx.rect(s+this.borderWidth+this.padding,r+this.borderWidth+this.padding,e,this.boxHeight-this.borderWidth-2*this.padding),this.canvasCtx.closePath(),this.canvasCtx.clip(),this.canvasCtx.fillStyle=n,this.canvasCtx.fillText(t,s+this.borderWidth+this.padding,r+this.boxHeight/2+this.borderWidth),this.canvasCtx.restore())},t.prototype.updateTooltip=function(t){this.tooltip.function.innerText=t.func,t.file||0<t.line?this.tooltip.file.innerText=t.file+":"+t.line:this.tooltip.file.innerText="",this.tooltip.count.innerText=(t.countLabel||t.count+" samples").toString();var e=(100*t.count/this.data[this.currentSelection].count).toFixed()+"% of root",e=(this.activeNode.count!=this.data[this.currentSelection].count&&(e=e+", "+(100*t.count/this.activeNode.count).toFixed()+"% of top"),this.tooltip.percentage.innerText=e,[]),t=(1&t.flags&&e.push("runtime-dispatch"),2&t.flags&&e.push("GC"),8&t.flags&&e.push("compilation"),16&t.flags&&e.push("task"),"");0<e.length&&(t="Flags: "+e.join(", ")),this.tooltip.flags.innerText=t,this.ctrlClickHandler&&(this.tooltip.ctrlClickHint.innerText="Ctrl/Cmd+Click to open this file")},t.prototype.drawHoverNode=function(t){this.hoverCanvasCtx.fillStyle=this.borderColor,this.hoverCanvasCtx.fillRect(t.pos.x,t.pos.y+this.borderWidth,Math.max(1,t.pos.width),t.pos.height-this.borderWidth);var e=t.pos.width-2*this.borderWidth*this.scale;1<e&&this.hoverCanvasCtx.clearRect(t.pos.x+this.borderWidth*this.scale,t.pos.y+2*this.borderWidth*this.scale,e,t.pos.height-3*this.borderWidth*this.scale),this.updateTooltip(t)},t.prototype.clearHover=function(){this.hoverCanvasCtx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.tooltipElement.style.display="none"},t.prototype.drawHover=function(t,e,i){var n=this,o=!1;return this.runOnNodeAtMousePosition(t,e,i,function(t){n.drawHoverNode(t),o=!0}),o},t.prototype.runOnNodeAtMousePosition=function(t,e,i,n){if(e>=Math.floor(t.pos.x)&&e<=Math.ceil(t.pos.x+t.pos.width)&&i>=t.pos.y){if(i<=t.pos.y+t.pos.height)return n(t),!0;for(var o=0,s=t.children;o<s.length;o++){var r=s[o];if(this.runOnNodeAtMousePosition(r,e,i,n))return!0}}return!1},t.prototype.zoomInOnNode=function(t,e,i){var n=this,o=!1;return this.runOnNodeAtMousePosition(t,e,i,function(t){n.clearHover(),n.activeNode=t,o=!0}),o},t.prototype.findParentNode=function(t,e){for(var i=0,n=(e=null===(e=void 0===e?null:e)?this.data[this.currentSelection]:e).children;i<n.length;i++){var o=n[i];if(o===t)return e;o=this.findParentNode(t,o);if(o)return o}return null},t}();export{ProfileViewer};